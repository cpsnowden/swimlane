on:
  push:
    branches: ["master", "native"]

env:
  PROJECT_ID: wagon-bootcamp-374809
  GAR_LOCATION: europe-west2
  #  https://console.cloud.google.com/artifacts/docker/wagon-bootcamp-374809/europe-west2/personal-projects?project=wagon-bootcamp-374809
  REPOSITORY: personal-projects
  SERVICE: swimlane-native
  REGION: europe-west2

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build Application
    steps:
      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      - name: Checkout the code
        uses: actions/checkout@master

      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: '11'

      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: Build with Gradle
        uses: gradle/gradle-build-action@749f47bda3e44aa060e82d7b3ef7e40d953bd629
        with:
          arguments: |-
            build 
            -Dquarkus.package.type=native 
            -Dquarkus.container-image.build=true 
            -Dquarkus.container-image.image=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE }}:${{ github.sha }} 
            -Dquarkus.container-image.push=true 

#      - name: Upload Build Artifact
#        uses: actions/upload-artifact@v2
#        with:
#          name: quarkus-app
#          path: build/*-runner
#
#      - name: Upload Docker Files
#        uses: actions/upload-artifact@v3
#        with:
#          name: dockerfiles
#          path: src/main/docker

  # Based on https://github.com/google-github-actions/example-workflows/blob/main/workflows/deploy-cloudrun/cloudrun-docker.yml
  # TODO Push this into gradle given quarkus can do the image build https://quarkus.io/guides/container-image
#  docker:
#    name: Create Native Docker Image and Push
#    runs-on: ubuntu-latest
#    needs: build
#    steps:
#      - name: Docker Auth
#        id: docker-auth
#        uses: 'docker/login-action@v1'
#        with:
#          registry: ${{ env.GAR_LOCATION }}-docker.pkg.dev
#          username: _json_key
#          password: ${{ secrets.GCP_CREDENTIALS }}
#
#      - name: Download Build
#        uses: actions/download-artifact@v3
#        with:
#          name: quarkus-app
#          path: build
#
#      - name: Download Docker Files
#        uses: actions/download-artifact@v3
#        with:
#          name: dockerfiles
#          path: dockerfiles
#
#      - name: Build and Push Container
#        run: |-
#          docker build -t "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE }}:${{ github.sha }}" -f dockerfiles/Dockerfile.native ./
#          docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE }}:${{ github.sha }}"

  deploy:
    name: Deploy Image to Cloud Run
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v1'
        with:
         credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v1
        with:
          service: ${{ env.SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE }}:${{ github.sha }}

    environment:
        name: production
        url: ${{ steps.deploy.outputs.url }}/q/swagger-ui/
